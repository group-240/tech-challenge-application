# üìä Estrat√©gia SRE de Logging - Tech Challenge

## üéØ Vis√£o Geral

Esta aplica√ß√£o implementa **pr√°ticas de logging do Google SRE** (Site Reliability Engineering) com **logs estruturados em JSON** para o ambiente **dev**.

Baseado em: [Google SRE Book - Monitoring Distributed Systems](https://sre.google/sre-book/monitoring-distributed-systems/)

---

## üìã Categoriza√ß√£o de Logs SRE

### **N√≠veis de Severidade**

| N√≠vel | Quando Usar | Exemplos | A√ß√£o Requerida |
|-------|-------------|----------|----------------|
| **DEBUG** | Diagn√≥stico detalhado em desenvolvimento | Valores de vari√°veis, fluxo de execu√ß√£o | Nenhuma (dev only) |
| **INFO** | Eventos normais e esperados | Order created, Payment processed | Nenhuma |
| **WARN** | Situa√ß√µes anormais MAS recuper√°veis | Retry bem-sucedido, Cache miss, Recurso pr√≥ximo do limite | Investigar se recorrente |
| **ERROR** | Falhas que impedem uma opera√ß√£o | Exception, Timeout, Falha de integra√ß√£o | Investigar ASAP |
| **FATAL** | Falhas cr√≠ticas do sistema | OOM, Falha no startup, Perda de BD | **ALERTA IMEDIATO** |

---

## üîç Categoriza√ß√£o Detalhada

### **1. INFO - Eventos Normais** ‚úÖ

**Quando usar:**
- ‚úÖ Opera√ß√µes bem-sucedidas
- ‚úÖ Marcos importantes do fluxo
- ‚úÖ Inicializa√ß√£o de componentes
- ‚úÖ Conclus√£o de processamentos

**Exemplos corretos:**
```java
// ‚úÖ BOM: Opera√ß√£o de neg√≥cio bem-sucedida
logger.info("Order created successfully: orderId={}, customerId={}, amount={}", 
            orderId, customerId, amount);

// ‚úÖ BOM: Integra√ß√£o externa bem-sucedida
logger.info("Payment processed via Mercado Pago: transactionId={}, amount={}", 
            transactionId, amount);

// ‚úÖ BOM: Inicializa√ß√£o
logger.info("Application started successfully on port {}", port);
```

**‚ùå Exemplos ERRADOS:**
```java
// ‚ùå RUIM: Muito verboso (use DEBUG)
logger.info("Entering method createOrder with parameters: {}", params);

// ‚ùå RUIM: Informa√ß√£o in√∫til
logger.info("Loop iteration {}", i);

// ‚ùå RUIM: Deve ser WARN (situa√ß√£o anormal)
logger.info("Product not found in cache, fetching from database");
```

---

### **2. WARN - Situa√ß√µes Anormais (Mas Recuper√°veis)** ‚ö†Ô∏è

**Quando usar:**
- ‚ö†Ô∏è Sistema se recuperou, mas algo n√£o estava ideal
- ‚ö†Ô∏è Configura√ß√£o faltando (usando default)
- ‚ö†Ô∏è Performance degradada
- ‚ö†Ô∏è Valida√ß√£o de neg√≥cio esperada
- ‚ö†Ô∏è Cache miss ou fallback

**Exemplos corretos:**
```java
// ‚úÖ BOM: Retry bem-sucedido ap√≥s falha
logger.warn("External API call failed, retry {} of {} succeeded", retryCount, maxRetries);

// ‚úÖ BOM: Performance degradada
logger.warn("Database query took {}ms, exceeding threshold of {}ms", duration, threshold);

// ‚úÖ BOM: Cache miss (degrada√ß√£o de performance)
logger.warn("Product {} not found in cache, fetching from database: productId={}", 
            productName, productId);

// ‚úÖ BOM: Valida√ß√£o de neg√≥cio esperada
logger.warn("Customer CPF already exists, returning existing customer: cpf={}", cpf);

// ‚úÖ BOM: Recurso pr√≥ximo do limite
logger.warn("Database connection pool at {}% capacity", utilizationPercent);

// ‚úÖ BOM: Configura√ß√£o faltando
logger.warn("API_TIMEOUT not configured, using default value: {}ms", defaultTimeout);
```

**‚ùå Exemplos ERRADOS:**
```java
// ‚ùå RUIM: Deve ser INFO (opera√ß√£o bem-sucedida)
logger.warn("Order created successfully");

// ‚ùå RUIM: Deve ser ERROR (falha n√£o recuperada)
logger.warn("Failed to connect to database after 3 retries");

// ‚ùå RUIM: Muito verboso
logger.warn("Method took 100ms to execute");
```

**‚ö†Ô∏è IMPORTANTE:** WARN N√ÉO √© erro! Sistema est√° funcionando, mas n√£o de forma ideal.

---

### **3. ERROR - Falhas de Opera√ß√£o** üî¥

**Quando usar:**
- üî¥ Exce√ß√µes inesperadas
- üî¥ Falha de integra√ß√£o com API externa
- üî¥ Erro de banco de dados
- üî¥ Timeout
- üî¥ Falha de autentica√ß√£o

**Exemplos corretos:**
```java
// ‚úÖ BOM: Exce√ß√£o com stack trace
try {
    orderRepository.save(order);
} catch (DataAccessException e) {
    StructuredLogger.setError("DATABASE_SAVE_FAILED", e.getMessage());
    logger.error("Failed to save order to database: orderId={}", orderId, e);
    throw e;
}

// ‚úÖ BOM: Timeout de API externa
logger.error("Payment gateway timeout after {}s: transactionId={}", 
            timeoutSeconds, transactionId);

// ‚úÖ BOM: Falha de autentica√ß√£o
logger.error("Failed to authenticate with Cognito: userId={}, error={}", 
            userId, errorMessage);
```

**‚ùå Exemplos ERRADOS:**
```java
// ‚ùå RUIM: Deve ser WARN (recuper√°vel)
logger.error("Retry attempt 2 of 3");

// ‚ùå RUIM: Sem stack trace (sempre incluir exce√ß√£o)
try {
    // c√≥digo
} catch (Exception e) {
    logger.error("Error: " + e.getMessage()); // ‚ùå Sem stack trace!
}

// ‚ùå RUIM: Deve ser INFO (valida√ß√£o esperada)
logger.error("Customer not found with CPF: {}", cpf);
```

**‚ö†Ô∏è SEMPRE incluir a exce√ß√£o completa:** `logger.error("Message", exception)`

---

### **4. FATAL - Falhas Cr√≠ticas** üíÄ

**Quando usar:**
- üíÄ Falha ao iniciar aplica√ß√£o
- üíÄ OutOfMemoryError
- üíÄ Perda de conex√£o com recurso cr√≠tico
- üíÄ Corrup√ß√£o de dados

**Exemplos corretos:**
```java
// ‚úÖ BOM: Falha cr√≠tica no startup
try {
    dataSource.getConnection();
} catch (SQLException e) {
    logger.error("FATAL: Failed to connect to database on startup", e);
    System.exit(1); // Aplica√ß√£o n√£o pode continuar
}

// ‚úÖ BOM: OutOfMemoryError
catch (OutOfMemoryError e) {
    logger.error("FATAL: OutOfMemoryError - Application terminating", e);
    System.exit(1);
}
```

**‚ö†Ô∏è Sistema est√° INDISPON√çVEL ap√≥s FATAL!**

---

## üè∑Ô∏è Categorias Especiais SRE

Al√©m da severidade, usamos **categorias** para facilitar an√°lise:

### **BUSINESS** - Eventos de Neg√≥cio

```java
StructuredLogger.setCategory(LogCategory.BUSINESS);
StructuredLogger.setOperation("CreateOrder");
StructuredLogger.setOrderId(orderId);

logger.info("Order created successfully");
```

**Quando usar:**
- Cria√ß√£o de pedidos
- Processamento de pagamentos
- Registro de clientes
- Mudan√ßas de status importantes

### **SECURITY** - Eventos de Seguran√ßa

```java
StructuredLogger.setCategory(LogCategory.SECURITY);
StructuredLogger.setUserId(userId);
StructuredLogger.put("action", "ACCESS_DENIED");

logger.warn("Unauthorized access attempt detected");
```

**Quando usar:**
- Tentativas de acesso n√£o autorizado
- Falhas de autentica√ß√£o
- Viola√ß√µes de rate limit
- Detec√ß√£o de atividades suspeitas

### **AUDIT** - Auditoria

```java
StructuredLogger.setCategory(LogCategory.AUDIT);
StructuredLogger.setUserId(userId);
StructuredLogger.put("action", "DELETE_PRODUCT");
StructuredLogger.put("resource", productId);

logger.info("Product deleted by admin");
```

**Quando usar:**
- A√ß√µes administrativas
- Altera√ß√µes em dados sens√≠veis
- Rastreabilidade legal

### **PERFORMANCE** - M√©tricas de Performance

```java
StructuredLogger.setCategory(LogCategory.PERFORMANCE);
StructuredLogger.setDuration(executionTime);

if (executionTime > 1000) {
    logger.warn("Slow database query detected: {}ms", executionTime);
}
```

**Quando usar:**
- Queries lentas
- Lat√™ncia de APIs
- Uso de recursos

### **INTEGRATION** - Integra√ß√µes Externas

```java
StructuredLogger.setCategory(LogCategory.INTEGRATION);
StructuredLogger.setOperation("CallMercadoPago");
StructuredLogger.setDuration(duration);

logger.info("Payment gateway response received");
```

**Quando usar:**
- Chamadas para APIs externas
- Webhooks recebidos
- Mensageria (SQS, SNS)

---

## üìä Formato JSON dos Logs

Todos os logs s√£o gerados em **JSON estruturado**:

```json
{
  "timestamp": "2025-10-06T14:30:45.123Z",
  "severity": "INFO",
  "logger_name": "com.fiap.techchallenge.application.usecases.order.CreateOrderUseCase",
  "thread": "http-nio-8080-exec-1",
  "message": "Order created successfully",
  "application": "tech-challenge-api",
  "environment": "dev",
  "service": "tech-challenge-api",
  "correlationId": "abc-123-def-456",
  "log_category": "BUSINESS",
  "operation": "CreateOrder",
  "orderId": "ORD-789",
  "customerId": "CUST-456",
  "amount": "150.00",
  "duration_ms": "245"
}
```

### **Campos Padr√£o**

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `timestamp` | string | Data/hora em UTC (ISO 8601) |
| `severity` | string | N√≠vel do log (INFO, WARN, ERROR, FATAL) |
| `logger_name` | string | Classe que gerou o log |
| `thread` | string | Thread da execu√ß√£o |
| `message` | string | Mensagem descritiva |
| `application` | string | Nome da aplica√ß√£o |
| `environment` | string | Ambiente (sempre "dev") |
| `service` | string | Nome do servi√ßo |

### **Campos Contextuais**

| Campo | Tipo | Descri√ß√£o | Quando Presente |
|-------|------|-----------|-----------------|
| `correlationId` | string | ID para rastreamento end-to-end | Todas requisi√ß√µes HTTP |
| `log_category` | string | Categoria (BUSINESS, SECURITY, etc.) | Quando definido |
| `operation` | string | Opera√ß√£o sendo executada | Quando definido |
| `userId` | string | ID do usu√°rio | Quando dispon√≠vel |
| `orderId` | string | ID do pedido | Opera√ß√µes de pedido |
| `customerId` | string | ID do cliente | Opera√ß√µes de cliente |
| `paymentId` | string | ID do pagamento | Opera√ß√µes de pagamento |
| `productId` | string | ID do produto | Opera√ß√µes de produto |
| `duration_ms` | number | Dura√ß√£o em milissegundos | Opera√ß√µes medidas |
| `http_method` | string | M√©todo HTTP | Requisi√ß√µes HTTP |
| `http_status` | number | Status code HTTP | Respostas HTTP |
| `endpoint` | string | Endpoint da requisi√ß√£o | Requisi√ß√µes HTTP |
| `error_code` | string | C√≥digo do erro | Quando h√° erro |
| `error_message` | string | Mensagem do erro | Quando h√° erro |
| `stack_trace` | string | Stack trace completo | Apenas em ERROR/FATAL |

---

## üíª Como Usar na Aplica√ß√£o

### **1. Importar as classes**

```java
import com.fiap.techchallenge.infrastructure.logging.StructuredLogger;
import com.fiap.techchallenge.infrastructure.logging.LogCategory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
```

### **2. Criar logger na classe**

```java
private static final Logger logger = LoggerFactory.getLogger(MinhaClasse.class);
```

### **3. Usar StructuredLogger para contexto**

```java
public void createOrder(CreateOrderDTO dto) {
    long startTime = System.currentTimeMillis();
    
    try {
        // Adicionar contexto SRE
        StructuredLogger.generateCorrelationId(); // Gera automaticamente
        StructuredLogger.setCategory(LogCategory.BUSINESS);
        StructuredLogger.setOperation("CreateOrder");
        StructuredLogger.setCustomerId(dto.getCustomerId());
        StructuredLogger.put("amount", String.valueOf(dto.getTotalAmount()));
        
        // INFO: Opera√ß√£o iniciada
        logger.info("Order creation started");
        
        // L√≥gica de neg√≥cio...
        Order order = orderService.create(dto);
        
        StructuredLogger.setOrderId(order.getId());
        
        // INFO: Opera√ß√£o conclu√≠da
        long duration = System.currentTimeMillis() - startTime;
        StructuredLogger.setDuration(duration);
        logger.info("Order created successfully");
        
        return order;
        
    } catch (BusinessException e) {
        // WARN: Valida√ß√£o de neg√≥cio (esperado)
        logger.warn("Order validation failed: {}", e.getMessage());
        throw e;
        
    } catch (Exception e) {
        // ERROR: Erro inesperado
        StructuredLogger.setError("ORDER_CREATION_FAILED", e.getMessage());
        logger.error("Failed to create order", e); // ‚ö†Ô∏è Sempre incluir exce√ß√£o!
        throw e;
        
    } finally {
        // SEMPRE limpar contexto
        StructuredLogger.clear();
    }
}
```

---

## üîç Queries √öteis

### **CloudWatch Logs Insights**

```sql
-- Buscar todos os ERRORs
fields @timestamp, severity, message, error_code, error_message, stack_trace
| filter severity = "ERROR"
| sort @timestamp desc
| limit 100

-- Buscar opera√ß√µes lentas (>500ms)
fields @timestamp, operation, duration_ms, message
| filter duration_ms > 500
| sort duration_ms desc
| limit 50

-- Buscar erros por tipo
fields error_code, error_message
| filter severity = "ERROR"
| stats count() by error_code
| sort count desc

-- Buscar eventos de seguran√ßa
fields @timestamp, userId, message, endpoint
| filter log_category = "SECURITY"
| sort @timestamp desc

-- Buscar eventos de neg√≥cio
fields @timestamp, operation, orderId, customerId, amount
| filter log_category = "BUSINESS"
| sort @timestamp desc
```

### **kubectl**

```bash
# Buscar ERRORs
kubectl logs deployment/tech-challenge-app -n tech-challenge | grep '"severity":"ERROR"'

# Buscar por correlationId
kubectl logs deployment/tech-challenge-app -n tech-challenge | grep '"correlationId":"abc-123"'

# Buscar eventos de neg√≥cio
kubectl logs deployment/tech-challenge-app -n tech-challenge | grep '"log_category":"BUSINESS"'
```

---

## ‚úÖ Checklist SRE

Ao adicionar logs, pergunte:

- [ ] **Severidade correta?** (INFO/WARN/ERROR/FATAL)
- [ ] **Mensagem clara?** Descreve o que aconteceu?
- [ ] **Contexto suficiente?** Tem IDs relevantes?
- [ ] **Categoria definida?** (BUSINESS, SECURITY, etc.)
- [ ] **Exce√ß√£o inclu√≠da?** (se for ERROR)
- [ ] **MDC limpo?** (`StructuredLogger.clear()` no finally)
- [ ] **Formato JSON?** Todos os logs est√£o estruturados?

---

## üìö Refer√™ncias

- [Google SRE Book - Monitoring](https://sre.google/sre-book/monitoring-distributed-systems/)
- [Logback JSON Encoder](https://github.com/logfellow/logstash-logback-encoder)
- [SLF4J Documentation](http://www.slf4j.org/)
- [MDC (Mapped Diagnostic Context)](http://logback.qos.ch/manual/mdc.html)

---

## üéØ Resumo

‚úÖ **Ambiente:** dev (somente JSON)  
‚úÖ **Formato:** JSON estruturado  
‚úÖ **Severidade:** INFO, WARN, ERROR, FATAL  
‚úÖ **Categorias:** BUSINESS, SECURITY, AUDIT, PERFORMANCE, INTEGRATION  
‚úÖ **Contexto:** MDC com correlation ID e campos relevantes  
‚úÖ **Rastreabilidade:** Correlation ID em todas as requisi√ß√µes  
‚úÖ **Performance:** Dura√ß√£o de opera√ß√µes medida automaticamente  

**Logs profissionais seguindo pr√°ticas do Google SRE! üöÄ**
